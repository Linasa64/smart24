<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<script language="javascript">
  function map(x, a, b) {
    return (x - a) / (b - a);
  }

  function map2(x, a, b, c, d) {
    return map(x, a, b) * (d - c) + c;
  }


  function absArray(array) {

    result = [];

    array.forEach(element => {
      result.push(Math.abs(element).toFixed(3));
    });


    return result;
  }

  function changeColor(mass) {
    if (mass > 0) {
      document.getElementById("water").style.fill = "rgb(85, 186, 218)";
      document.getElementById("legendR").style.fill = "rgb(85, 186, 218)";
      newInnerHTML = document.getElementById("explanations").innerHTML.replace("perdront", "gagneront");
      document.getElementById("explanations").innerHTML = newInnerHTML;
    } else {
      document.getElementById("water").style.fill = "red"
      document.getElementById("legendR").style.fill = "red"
      newInnerHTML = document.getElementById("explanations").innerHTML.replace("gagneront", "perdront");
      document.getElementById("explanations").innerHTML = newInnerHTML;
    }
  }

  function createValuesForGlass(masses) {

    valuesSVG = [];
    absoluteMasses = absArray(masses);
    water = document.getElementById("water");
    var yTopWater = parseInt(water.getAttribute("y"));
    var yBottomWater = parseInt(water.getAttribute("y")) + parseInt(water.getAttribute("height"));


    max = Math.max(...absoluteMasses);
    min = Math.min(...absoluteMasses);

    absoluteMasses.forEach(element => {
      valuesSVG.push(map2(element, max, min, yTopWater, yBottomWater));
    });

    return valuesSVG;

  }

  function change(val) {

    index = val - 2000;
    year = document.getElementById("year");
    m = absArray(masses);

    water = document.getElementById("water");
    legendRectangle = document.getElementById("legendR");

    document.getElementById("mass").innerHTML = m[index] + "M3";
    year.innerHTML = val;



    numbers = document.getElementById("explanations").innerHTML.match(/[0-9]+(\.?[0-9]+)/g);

    newInnerHTML = document.getElementById("explanations").innerHTML.replace(numbers[0], m[index])
    document.getElementById("explanations").innerHTML = newInnerHTML;

    newInnerHTML = document.getElementById("explanations").innerHTML.replace(numbers[1], val)
    document.getElementById("explanations").innerHTML = newInnerHTML;

    let translateYValue = mSVG[index] - parseInt(year.getAttribute("y"));

    // Appliquer la transformation
    year.style.transform = `translateY(${translateYValue}px)`;

    //year.setAttribute("y",mSVG[index])
    water.setAttribute("y", mSVG[index])
    changeColor(masses[index]);

  }

  function init() {
    masses = [];
    for (let index = 0; index <= 100; index++) {
      masses.push(map2(Math.random(), 0, 1, -1000, 1000));
    }

    mSVG = createValuesForGlass(masses);

    return mSVG;
  }
</script>

<style>
  .animation {
    display: inline-block;
    text-align: center;
  }

  input[type=range].anim-slider {
    width: 80%;
    margin-left: auto;
    margin-right: auto;
  }

  .anim-buttons {
    margin: 8px 0px;
  }

  .anim-buttons button {
    padding: 0;
    width: 36px;
  }

  .anim-state label {
    margin-right: 8px;
  }

  .anim-state input {
    margin: 0;
    vertical-align: middle;
  }

  .water-animation {
    transition: y 1s ease, fill 0.5s ease, transform 1s ease;
    /* Définit la transition de la hauteur avec une durée de 0.5 seconde */
  }
</style>

<div class="animation" style="background-color:white">
  <svg width="800" height="350" xmlns="http://www.w3.org/2000/svg">

    <!-- Water -->

    <!--<path id="water" style="paint-order: stroke; fill: rgb(85, 186, 218); stroke-width: 50px;" d="M 48.627 305.639 L 122.627 593.639 L 371.627 593.639 L 445.627 305.639"/>> -->
    <rect id="water" x="50" y="50" width="200" height="300" fill="rgb(85, 186, 218)" class="water-animation" />
    <polyline id="glass" style="stroke: black; paint-order: stroke; fill: none; stroke-width: 3px;"
      points="50,50 50,350 250,350 250,50" />

    <!-- Texts -->
    <text id="mass" style="white-space: pre; fill: black; font-family: Arial, sans-serif; font-size: 28px;"
      class="water-animation" x="100" y="200">654 M3</text>
    <text id="year" style="white-space: pre; fill: black; font-family: Arial, sans-serif; font-size: 28px;"
      class="water-animation" x="125" y="49">2048</text>

    <!-- Legend -->
    <rect id="legendR" x="300" y="50" width="50" height="30" fill="rgb(85, 186, 218)" />
    <text style="white-space: pre; fill: black; font-family: Arial, sans-serif; font-size: 16px;" x="370" y="70">Mass
      balance</text>
    <image x="300" y="150" height="50" width="50" href="../static/images/light-bulb.png" />
    <text id="explanations" style="white-space: pre; fill: black; font-family: Arial, sans-serif; font-size: 16px;"
      x="370" y="170">Les glaciers européens perdront 654M3 sur l'année 2048.</text>
    <text style="white-space: pre; fill: black; font-family: Arial, sans-serif; font-size: 16px;" x="370" y="200">Soit
      pas moins de 4 piscines olympiques.</text>

  </svg>

  <div class="anim-controls">
    <input id="anim_slider" type="range" class="anim-slider" name="points" min="2000" max="2100" step="1" value="2000"
      oninput="change(parseInt(this.value))">
  </div>
</div>
<script language="javascript">
  init();
</script>